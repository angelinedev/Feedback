{
  "entities": {
    "Student": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Student",
      "type": "object",
      "description": "Represents a student record.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the student entity."
        },
        "registerNumber": {
          "type": "string",
          "description": "The student's registration number. Must be a 16-digit number."
        },
        "password": {
          "type": "string",
          "description": "The hashed password for student authentication. DO NOT STORE PLAINTEXT PASSWORDS."
        },
        "className": {
          "type": "string",
          "description": "The class name the student belongs to."
        },
        "name": {
          "type": "string",
          "description": "The name of the student."
        }
      },
      "required": [
        "id",
        "registerNumber",
        "password",
        "className",
        "name"
      ]
    },
    "Faculty": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Faculty",
      "type": "object",
      "description": "Represents a faculty member.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the faculty entity."
        },
        "facultyId": {
          "type": "string",
          "description": "The faculty's ID. Must be a 3-4 digit number."
        },
        "password": {
          "type": "string",
          "description": "The hashed password for faculty authentication. DO NOT STORE PLAINTEXT PASSWORDS."
        },
        "name": {
          "type": "string",
          "description": "The name of the faculty member."
        },
        "department": {
          "type": "string",
          "description": "The department the faculty member belongs to."
        }
      },
      "required": [
        "id",
        "facultyId",
        "password",
        "name",
        "department"
      ]
    },
    "Question": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Question",
      "type": "object",
      "description": "Represents a feedback question.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the question entity."
        },
        "text": {
          "type": "string",
          "description": "The text of the feedback question."
        }
      },
      "required": [
        "id",
        "text"
      ]
    },
    "ClassFacultyMapping": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ClassFacultyMapping",
      "type": "object",
      "description": "Represents the mapping between classes, faculty, and subjects.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the mapping entity."
        },
        "className": {
          "type": "string",
          "description": "The name of the class."
        },
        "facultyId": {
          "type": "string",
          "description": "Reference to Faculty. (Relationship: Faculty 1:N ClassFacultyMapping)"
        },
        "subject": {
          "type": "string",
          "description": "The subject being taught."
        }
      },
      "required": [
        "id",
        "className",
        "facultyId",
        "subject"
      ]
    },
    "Feedback": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Feedback",
      "type": "object",
      "description": "Represents student feedback for a specific faculty/subject.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the feedback entity."
        },
        "studentId": {
          "type": "string",
          "description": "Reference to Student. (Relationship: Student 1:N Feedback)"
        },
        "classFacultyMappingId": {
          "type": "string",
          "description": "Reference to ClassFacultyMapping. (Relationship: ClassFacultyMapping 1:N Feedback)"
        },
        "questionRatings": {
          "type": "array",
          "description": "Array of ratings for each question (1-5).",
          "items": {
            "type": "number"
          }
        },
        "comment": {
          "type": "string",
          "description": "Optional anonymous comment from the student."
        },
        "submitted": {
          "type": "boolean",
          "description": "Indicates whether the feedback form has been submitted."
        }
      },
      "required": [
        "id",
        "studentId",
        "classFacultyMappingId",
        "questionRatings",
        "submitted"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/students/{studentId}",
        "definition": {
          "entityName": "Student",
          "schema": {
            "$ref": "#/backend/entities/Student"
          },
          "description": "Stores student data. Accessible only by the student with matching studentId. Used for authentication and profile information.",
          "params": [
            {
              "name": "studentId",
              "description": "The unique identifier for the student."
            }
          ]
        }
      },
      {
        "path": "/faculty/{facultyId}",
        "definition": {
          "entityName": "Faculty",
          "schema": {
            "$ref": "#/backend/entities/Faculty"
          },
          "description": "Stores faculty data. Accessible only by the faculty with matching facultyId. Used for authentication and profile information.",
          "params": [
            {
              "name": "facultyId",
              "description": "The unique identifier for the faculty member."
            }
          ]
        }
      },
      {
        "path": "/questions/{questionId}",
        "definition": {
          "entityName": "Question",
          "schema": {
            "$ref": "#/backend/entities/Question"
          },
          "description": "Stores feedback questions. Publicly readable to display in feedback forms.",
          "params": [
            {
              "name": "questionId",
              "description": "The unique identifier for the feedback question."
            }
          ]
        }
      },
      {
        "path": "/classFacultyMapping/{mappingId}",
        "definition": {
          "entityName": "ClassFacultyMapping",
          "schema": {
            "$ref": "#/backend/entities/ClassFacultyMapping"
          },
          "description": "Stores the class-faculty-subject mapping. Publicly readable for students to find their related feedback forms and also helps to generate faculty reports.",
          "params": [
            {
              "name": "mappingId",
              "description": "The unique identifier for the class-faculty mapping."
            }
          ]
        }
      },
      {
        "path": "/students/{studentId}/feedback/{feedbackId}",
        "definition": {
          "entityName": "Feedback",
          "schema": {
            "$ref": "#/backend/entities/Feedback"
          },
          "description": "Stores the feedback given by students. Includes denormalized 'studentId' and 'classFacultyMappingId'.",
          "params": [
            {
              "name": "studentId",
              "description": "The unique identifier for the student (used for path-based ownership)."
            },
            {
              "name": "feedbackId",
              "description": "The unique identifier for the feedback record."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the FeedLoop v2 application's requirements for student feedback collection and faculty reporting, while adhering to the principles of Authorization Independence, Structural Segregation, and Access Modeling. It incorporates denormalization to avoid `get()` calls in security rules and enables secure list operations.\n\n*   **Authorization Independence:** The structure uses path-based ownership for student and faculty data and a membership map to manage access to feedback data. This approach eliminates the need for `get()` calls in security rules and enables atomic creation of parent/child documents.\n*   **Structural Segregation:** The data is segregated into separate collections based on entity type (students, faculty, questions, classFacultyMapping, and feedback). This segregation simplifies security rules by ensuring that all documents within a collection share the same access requirements.\n*   **Access Modeling:** The structure uses path-based ownership for private student and faculty data and a membership map for collaborative feedback data. This consistent access modeling simplifies security rules and makes the authorization logic more predictable.\n*   **QAPs (Rules are not Filters):** The segregation of data into separate collections based on entity type, along with path-based ownership and membership maps, enables secure `list` operations without relying on filtering in the rules.\n*   `/students/{studentId}` and `/faculty/{facultyId}`: Store private student and faculty data, respectively. Access is restricted to the authenticated user with the matching `studentId` or `facultyId`.\n*   `/questions/{questionId}`: Stores feedback questions. Publicly readable for displaying in feedback forms.\n*   `/classFacultyMapping/{mappingId}`: Stores the class-faculty-subject mapping. Publicly readable for students to find their related feedback forms and also helps to generate faculty reports.\n*   `/feedback/{feedbackId}`: Stores the feedback given by students. Includes `studentId` and `classFacultyMappingId` and uses path-based ownership (`/students/{studentId}/feedback/{feedbackId}`).\n\nDenormalization Strategy:\n\n*   The `Feedback` documents denormalize the `studentId` and `classFacultyMappingId` to allow easier querying and reporting.\n\nSecurity Rules Considerations:\n\n*   Rules will enforce that only the authenticated student can create feedback documents under their `studentId`.\n*   Rules will restrict faculty access to feedback reports based on the `classFacultyMappingId` and the faculty's `facultyId`.\n\nThis structure enables robust and easily debuggable security rules, ensures data integrity, and supports the application's features for student feedback collection and faculty reporting."
  }
}