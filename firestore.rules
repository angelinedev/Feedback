/**
 * @fileOverview Firestore Security Rules for FeedLoop v2.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for student and faculty data,
 * while allowing public read access to questions and class-faculty mappings. Feedback
 * data is secured under each student's path and enforces that only the student can
 * create, update, or delete their own feedback.
 *
 * Data Structure:
 * - /students/{studentId}: Stores student profile data; accessible only by the student.
 * - /faculty/{facultyId}: Stores faculty profile data; accessible only by the faculty member.
 * - /questions/{questionId}: Stores feedback questions; publicly readable.
 * - /classFacultyMapping/{mappingId}: Stores class-faculty-subject mappings; publicly readable.
 * - /students/{studentId}/feedback/{feedbackId}: Stores student feedback; accessible only by the student.
 *
 * Key Security Decisions:
 * - Students and faculty can only access their own profile data.
 * - Questions and class-faculty mappings are publicly readable to facilitate the display
 *   of feedback forms and faculty reporting.
 * - All write operations on feedback documents are restricted to the student who owns
 *   the document, enforced via path-based ownership.
 * - Listing of student and faculty documents is restricted.
 *
 * Denormalization for Authorization:
 * - The Feedback documents denormalize the studentId. This allows simpler security rules
 *   that check ownership without needing to perform additional `get()` operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces that students can only read and write their own profile data.
     * @path /students/{studentId}
     * @allow (create) User with UID 'student_abc' can create a document at /students/student_abc.
     * @allow (get, update, delete) User with UID 'student_abc' can get, update, or delete their own document at /students/student_abc.
     * @deny (create) User with UID 'other_user' cannot create a document at /students/student_abc.
     * @deny (get, update, delete) User with UID 'other_user' cannot get, update, or delete the document at /students/student_abc.
     * @principle Enforces document ownership for all operations.
     */
    match /students/{studentId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if false; // Listing student documents is not permitted.
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Enforces that faculty can only read and write their own profile data.
     * @path /faculty/{facultyId}
     * @allow (create) User with UID 'faculty_xyz' can create a document at /faculty/faculty_xyz.
     * @allow (get, update, delete) User with UID 'faculty_xyz' can get, update, or delete their own document at /faculty/faculty_xyz.
     * @deny (create) User with UID 'other_user' cannot create a document at /faculty/faculty_xyz.
     * @deny (get, update, delete) User with UID 'other_user' cannot get, update, or delete the document at /faculty/faculty_xyz.
     * @principle Enforces document ownership for all operations.
     */
    match /faculty/{facultyId} {
      function isOwner(facultyId) {
        return request.auth != null && request.auth.uid == facultyId;
      }

      function isExistingOwner(facultyId) {
        return isOwner(facultyId) && resource != null;
      }

      allow get: if isOwner(facultyId);
      allow list: if false; // Listing faculty documents is not permitted.
      allow create: if isOwner(facultyId);
      allow update: if isExistingOwner(facultyId);
      allow delete: if isExistingOwner(facultyId);
    }

    /**
     * @description Allows public read access to feedback questions.
     * @path /questions/{questionId}
     * @allow (get, list) Any user can read feedback questions.
     * @deny (create, update, delete) No one can create, update, or delete questions through client-side rules.
     * @principle Provides public read access to a collection.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to class-faculty mappings.
     * @path /classFacultyMapping/{mappingId}
     * @allow (get, list) Any user can read class-faculty mappings.
     * @deny (create, update, delete) No one can create, update, or delete class-faculty mappings through client-side rules.
     * @principle Provides public read access to a collection.
     */
    match /classFacultyMapping/{mappingId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces that students can only read and write their own feedback documents.
     * @path /students/{studentId}/feedback/{feedbackId}
     * @allow (create) User with UID 'student_abc' can create a feedback document under /students/student_abc/feedback/{feedbackId}
     * @allow (get, update, delete) User with UID 'student_abc' can get, update, or delete their own feedback document under /students/student_abc/feedback/{feedbackId}.
     * @deny (create) User with UID 'other_user' cannot create a feedback document under /students/student_abc/feedback/{feedbackId}.
     * @deny (get, update, delete) User with UID 'other_user' cannot get, update, or delete the feedback document under /students/student_abc/feedback/{feedbackId}.
     * @principle Enforces path-based ownership for feedback documents.
     */
    match /students/{studentId}/feedback/{feedbackId} {
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get, list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }
  }
}